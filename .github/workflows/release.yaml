# based on: https://github.com/skanehira/rust-cli-template/blob/main/.github/workflows/release.yaml(LICENSE: The MIT License (MIT) - Copyright (c) 2025 skanehira https://github.com/skanehira/rust-cli-template/blob/main/LICENSE)

name: Release
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build - ${{matrix.target}}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            os: Linux
            arch: x86_64
            ext: tar.gz
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-24.04-arm
            os: Linux
            arch: arm64
            ext: tar.gz
          - target: x86_64-apple-darwin
            runner: macos-15-intel
            os: Darwin
            arch: x86_64
            ext: tar.gz
          - target: aarch64-apple-darwin
            runner: macos-latest
            os: Darwin
            arch: arm64
            ext: tar.gz
          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            os: Windows
            arch: x86_64
            ext: zip
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Setup environment variables for sccache
        shell: bash
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
          echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1.15.2
        with:
          rustflags: ""

      - name: Get project name
        id: project
        shell: bash
        run: |
          name=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[0].name')
          echo "name=$name" >> "$GITHUB_OUTPUT"

      - name: Build
        run: cargo build --release

      - name: Create archive (Unix)
        if: matrix.os != 'Windows'
        shell: bash
        run: |
          name="${{ steps.project.outputs.name }}"
          archive_name="${name}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz"
          tar -czvf "$archive_name" -C target/release "$name"
          echo "archive_name=$archive_name" >> "$GITHUB_ENV"

      - name: Create archive (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          $name = "${{ steps.project.outputs.name }}"
          $archiveName = "${name}_${{ matrix.os }}_${{ matrix.arch }}.zip"
          Compress-Archive -Path "target/release/${name}.exe" -DestinationPath $archiveName
          echo "archive_name=$archiveName" >> $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ steps.project.outputs.name }}_${{ matrix.os }}_${{ matrix.arch }}
          path: ${{ env.archive_name }}
          if-no-files-found: error

  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          prev_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$prev_tag" ]; then
            echo "## Changes since $prev_tag" > changelog.md
            echo "" >> changelog.md
            git log --pretty=format:"- %s" "$prev_tag"..HEAD >> changelog.md
          else
            echo "## Initial Release" > changelog.md
          fi

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --notes-file changelog.md \
            artifacts/*
